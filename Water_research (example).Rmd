---
title: "Оценка объема речного стока в Южной Калифорнии"
author: "Рева В.А."
date: "8/6/2020"
output:
  html_document: default
---
```{r setup, include=FALSE}
# Настройки R и knitr ----------------------------
options(width = 70, scipen = 16, digits = 3) 
# опции чанков
knitr::opts_chunk$set(tidy = FALSE, # сохранять форматирование кода
               fig.width = 9, # ширина рисунков по умолчанию
               fig.height = 6, # высота рисунков по умолчанию
               echo = TRUE, eval = TRUE, warning = FALSE)  
```
## Введение

Жители Южной Калифорнии в течение многих лет страдают от нехватки пресной воды. По данным некоторых авторов общий расход пресной воды в домах жителей Ю.Калифорнии сопоставим с таковым в Южном Судане, Руанде и Чаде.
В отличие от последних сенатор от Ю.Калифорнии инициировал проект по анализу уровня осадков и запасов пресной воды в целом.
Одним из важных источников пресной воды являются зимние осадки, которые могут оказывать влияние на речной сток (BSAAM), определяющий расход пресной воды в регионе в целом.
Мы предположили, что существует взаимосвязь между уровнем зимних осадков и речным стоком. Для проверки этой гипотезы проведено настоящее исследование.

## Материалы и методы

В период с 1948 по 1990 гг. проводили замеры зимних осадков в разных областях Ю.Калифорнии и оценивали общий речной сток в эти же годы.
Сбор данных производили в программе Excel (Microsoft).
Статистическую обработку данных проводили в программе R (версия 4.0.0, The R Foundation for Statistical Computing) [1] с использованием пакетов ggplot2, car, cowplot, dplyr.
```{r}
# Необходимые пакеты
library(ggplot2) #для построения графиков [2]
library(car)     #для построения квантильных графиков [3]
library(readxl)  #для работы с исходным файлом .xlsx [1]
library(cowplot) #для построения нескольких графиков в одном окне [4]
library(dplyr)   #для категоризации выборок [5]
library(carData)
theme_set(theme_bw())
```
В результате исследования получены данные, представленные в таблице (датафрейме) из файла "water.xlsx"
```{r}
water <- read_excel ("CourseProject_water.xlsx") #команда открытия файла
```

Структуру данных оцениваем с помощью команды
```{r}
str(water)
```
Данные в таблице описывают ежегодные замеры зимних осадков в разных регионах и общий речной сток за те же годы. Данные представлены таблицей 43х8. Соответственно все параметры (уровень осадков в разных регионах) измерены за 43 года в 6 регионах.

Выясняем, есть ли в датафрейме пропущенные значения
```{r}
sum(is.na(water))
```
Пропущенных значений в таблице нет.

Смотрим на средние значения и дисперсию всех представленных переменных
```{r}
summary(water)
```
Характер распределения данных оценивали визуально путем построения графиков
```{r}
set.seed(2856) #генерируем случайное число

## Ищем выбросы: диаграммы Кливленда для всех переменных (рис. 1)
gg_dot <- ggplot(water, aes(y = 1:nrow(water))) + geom_point() + ylab('index')
Pl1 <- gg_dot + aes(x = APMAM)
Pl2 <- gg_dot + aes(x = APSAB)
Pl3 <- gg_dot + aes(x = APSLAKE)
Pl4 <- gg_dot + aes(x = OPBPC)
Pl5 <- gg_dot + aes(x = OPRC)
Pl6 <- gg_dot + aes(x = OPSLAKE)
plot_grid(Pl1, Pl2, Pl3, Pl4, Pl5, Pl6, ncol = 3)
```
#__Рис.1.__ Диаграммы Кливленда для всех переменных и отклика, демонстирующие наличие выбросов в каждой из переменных.

Видны выбросы почти во всех выборках, что может негативно сказаться на информативности модели, поэтому с помощью построения диаграмм Кливленда выявляем, а затем удаляем эти выбросы.
```{r}
# Удаляем выбросы, выявленные путем построения диаграмм Кливленда
water2 <- water [ which (water$APMAM <15 & water$APSAB<10 & water$APSLAKE<8 & water$OPBPC<30 & water$OPSLAKE <30),]
```
Строим новые диаграммы Кливленда для всех переменных (рис.2):
```{r}
gg_dot <- ggplot(water2, aes(y = 1:nrow(water2))) + geom_point() + ylab('index')
Pl1 <- gg_dot + aes(x = APMAM)
Pl2 <- gg_dot + aes(x = APSAB)
Pl3 <- gg_dot + aes(x = APSLAKE)
Pl4 <- gg_dot + aes(x = OPBPC)
Pl5 <- gg_dot + aes(x = OPRC)
Pl6 <- gg_dot + aes(x = OPSLAKE)
plot_grid(Pl1, Pl2, Pl3, Pl4, Pl5, Pl6,ncol = 3)
```
#__Рис.2.__ Диаграммы Кливленда для всех переменных и отклика после удаления "выбросов" демонстрируют равномерное распределение данных.

Выбросы удалены. Далее оцениваем характер связи между зависимой переменной и предикторами (рис.3).
```{r}
gg_cor <- ggplot(water2, aes(y = BSAAM)) + geom_point() + geom_smooth(se = FALSE)
Pl1 <- gg_cor + aes(x = APMAM)
Pl2 <- gg_cor + aes(x = APSAB)
Pl3 <- gg_cor + aes(x = APSLAKE)
Pl4 <- gg_cor + aes(x = OPBPC)
Pl5 <- gg_cor + aes(x = OPRC)
Pl6 <- gg_cor + aes(x =  OPSLAKE)
plot_grid(Pl1, Pl2, Pl3, Pl4, Pl5, Pl6, ncol = 3)
```
#__Рис.3.__ Графики зависимостей речного стока (BSAAM) от предикторов (уровень зимних осадков в разных регионах). Видна линейная зависимость нижних графиков и нелинейная зависимость верхних.
.
Выявлено, что связь между APMAM, APSAB и APSLAKE нелинейна по отношению с BSAAM, что нарушает условие применимости линейной модели.
С целью стандартизации данных выполнены различные линеаризующие преобразования данных трех переменных (включая извлечение корня, возведение в квадрат, логарифмирование и др.).

```{r}
# Характер связи между зависимой переменной и предикторами с преобразованными переменными APMAM, APSAB и APSLAKE с помощью sqrt(x2) (рис.4):
gg_cor <- ggplot(water2, aes(y = BSAAM)) + geom_point() + geom_smooth(se = FALSE)
Pl1 <- gg_cor + aes(sqrt((x = APMAM)^2))
Pl2 <- gg_cor + aes(sqrt((x = APSAB)^2))
Pl3 <- gg_cor + aes(sqrt((x = APSLAKE)^2))
Pl4 <- gg_cor + aes(x = OPBPC)
Pl5 <- gg_cor + aes(x = OPRC)
Pl6 <- gg_cor + aes(x =  OPSLAKE)
plot_grid(Pl1, Pl2, Pl3, Pl4, Pl5, Pl6, ncol = 3)
```
#__Рис.4.__ Графики зависимостей речного стока (BSAAM) от предикторов (уровень зимних осадков в разных регионах) после линеаризующих преобразований. "Условно" преобразованным можно считать лишь один график зависимости отклика от переменной APMAM.

При этом график APMAM можно условно считать приведенным к линейному, остальные графики никак не реагируют на преобразование, а потому исключаются из регрессионной модели.

Строим модель множественной линейной регрессии
```{r}
water_mod <- lm(BSAAM ~ APMAM + OPBPC + OPRC + OPSLAKE, data = water2)
```

## Расчеты

Проверяем все условия применимости линейных моделей:
```{r}
# Проверяем на мультиколлинеарность построенную модель путем оценки фактора инфляции дисперсии (VIF)
vif(water_mod)

#Несколько предикторов избыточны (VIF > 3)
# Удаляем из модели OPSLAKE как наиболее избыточный предиктор
new_mod <- update(water_mod, ~.-OPSLAKE)

# снова проверяем на мультиколлинеарность
vif(new_mod)

# Удаляем из модели OPBPC как наиболее избыточный предиктор
new_mod2 <- update(new_mod, ~.-OPBPC)

# снова проверяем на мультиколлинеарность
vif(new_mod2)

# создаем новую модель уже без мультиколлинеарности
final_mod <- lm(BSAAM ~ APMAM + OPRC, data = water2)

## Записываем уравнение множественной регрессии с помощью коэффициентов регрессии
coef(final_mod)
```
Полученное уравнение множественной регрессии:
BSAAMfitted = 20491 + 578*APMAM + 4361*OPRC
```{r}
# Проводим анализ остатков
water_diag <- fortify(final_mod)

# Строим график расстояний Кука (рис. 5):
ggplot(water_diag, aes(x = 1:nrow(water_diag), y = .cooksd)) +
  geom_bar(stat = 'identity') + coord_cartesian(ylim = c(0, 2)) +
  geom_hline(yintercept = 1, linetype = 2)
```
#__Рис.5.__ График расстояний Кука, демонстрирующий отсутствие влиятельных наблюений.

Влиятельных наблюдений нет.

```{r}
# Строим график остатков от предсказанных значений (рис. 6):
gg_resid <- ggplot(data = water_diag, aes(x = .fitted, y = .stdresid)) +
  geom_point() + geom_hline(yintercept = 0) + geom_smooth()
gg_resid
```
#__Рис.6.__ График остатков от предсказанных значений, демонстрирующий отсутствие выбросов и гетерогенности дисперсии остатков.

Выбросов нет. Гетерогенность дисперсии не выявляется.

```{r}
## Графики зависимости остатков от предикторов в модели (рис. 7):
res_1 <- gg_resid + aes(x = APMAM)
res_2 <- gg_resid + aes(x = OPRC)

plot_grid(res_1, res_2, nrow = 2)
```
#__Рис.7.__ Графики зависимости остатков от предикторов в регрессионной модели (А - от предиктора APMAM, B - от предиктора OPRC).

```{r}
## Квантильный график остатков
qqPlot(final_mod)
```
#__Рис.8.__ Квантильный график остатков, демонстрирующий их нормальное распределение.
Отклонений от нормального распределения нет.

С помощью частного F-критерия оцениваем разницу объясненной дисперсии между моделями, т.е. насколько уменьшенная модель хуже нашей полной модели final_mod
```{r}
final_mod_APMAM <- update(final_mod, .~ .-APMAM)
anova(final_mod_APMAM, final_mod)
```
Получаем, что модель незначимо меняется при удалении предиктора APMAM.
Повторяем то же самое с предиктором OPRC:
```{r}
final_mod_OPRC <- update(final_mod, .~. - OPRC)
anova(final_mod_OPRC, final_mod)
```
Модель значимо ухудшается.
Проверяем еще раз значимость предикторов при помощи функции drop1()

```{r}
drop1(final_mod, test = 'F')
```

Предиктор APMAM оказывает незначимое влияние на модель, значит, в нашей итоговой модели остается только один предиктор OPRC
```{r}
water_final_mod <- lm (BSAAM ~ OPRC, data = water2)
```
Смотрим на значения коэффициентов:

```{r}
summary (water_final_mod)
```
## Результаты

Путем последовательного анализа данных и применения линейной регрессии с соблюдением условий ее применимости построена итоговая регрессионная модель зависимости речного стока от уровня зимних осадков:
BSAAMfitted = 23908 + 4410*OPRC
Данная модель статистически значима.
Выявлено, что результаты анализа уровня зимних осадков в регионе OPRC статистически значимо связаны с речным стоком BSAAM (t0.05, 37 = 12.47, p <0.0001).

Произведена визуализация модели (рис. 9)
```{r}
ggplot(water2, aes (x = OPRC, y = BSAAM)) + geom_point() + labs (x = 'Уровень зимних осадков (OPRC)', y = 'Речной сток (BSAAM)') + geom_smooth (method = 'lm')
```
#__Рис.9.__ График зависисимости речного стока от уровня зимних осадков демонстрирует линейную положительную зависимость.
Имеется линейная положительная зависимость между предиктором и откликом. Данная модель хорошо описывает исходные данные: r2 = 0.80 (80% изменчивости).

Выполнено построение графика предсказаний модели (рис. 10):

```{r}
water_predicted <- predict (water_final_mod, interval = 'prediction')
water_predicted <- data.frame (water2, water_predicted)
fitted_mod <- ggplot (water_predicted, aes (x = OPRC, y = BSAAM)) + geom_ribbon (aes(ymin = lwr, ymax = upr, fill = 'Для предсказаний'), alpha = 0.5) + geom_smooth (method = 'lm', aes (fill = 'Для регрессии')) + scale_fill_manual (name = 'Доверительные \nзоны', values = c ('powderblue', 'gray')) + geom_point () + labs (x = 'Уровень зимних осадков (OPRC)', y = 'Речной сток (BSAAM)', title = 'Доверительные зоны регрессии \nи ее предсказаний')
fitted_mod   
```
#__Рис.10.__ График предсказаний регрессионной модели и доверительной зоны регрессии показывает, что большинство значений переменной OPRC укладывается в предсказанные регрессионной моделью значения, что говорит о хорошем подборе модели.

В результате анализа оказалось, что речной сток BSAAM зависит только от одного предиктора - уровня зимних осадков в регионе OPRC. Регрессионная модель, включающая этот предиктор, описывает 80% изменчивости модели. Итоговый график предсказаний модели представлен на рисунке 10.

## Выводы

Наше исследование показало, что среди всех регионов, где в течение 43 лет был измерен уровень зимних осадков, только один OPRC оказывает статистически значимое влияние на общий речной сток BSAAM. Причины высокого уровня влияния данного фактора и отсутствия влияния зимних осадков в других регионах требуют дальнейшего изучения.

## Список литературы

[1] RStudio Team (2020). RStudio: Integrated Development for R. RStudio, PBC, Boston, MA URL http://www.rstudio.com/.

[2]. Wickham, H. (2016). ggplot2: elegant graphics for data analysis. Springer.

[3] Fox J, Weisberg S (2019). An R Companion to Applied Regression, Third edition. Sage, Thousand Oaks CA. https://socialsciences.mcmaster.ca/jfox/Books/Companion/.

[4] Wilke CO. https://www.rdocumentation.org/packages/cowplot

[5] Wickham H, François R, Henry L, Müller K. (2020). dplyr: A Grammar of Data Manipulation. R package version 1.0.0. https://CRAN.R-project.org/package=dplyr
